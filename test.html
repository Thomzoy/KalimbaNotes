<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tone.js Transport Schedule Example</title>
  <!-- Include Tone.js library -->
  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.37"></script>
</head>
<body>
  <h1>Tone.js Transport Schedule Example</h1>

  <!-- Add a button to start Tone.js -->
  <button id="startButton">Start Tone.js</button>

  <div id="noteDisplay"></div>

  <script>
    // Function to start Tone.js

    fetch(`songs/song2.json`)
        .then(response => response.json())
        .then(data => {

            synth.debug = true;
            //synth.maxPolyphony = 64;

            var now = Tone.now();
            // Get notes and sort by reverse time onset
            var notes = data["Notes"]
            notes.sort((a, b) => -b[0] + a[0]);

            var notes_to_display = []

            // Iterate over each note
            notes.forEach(function (note) {
                var noteDelay = DELAY * note[0];
                var noteId = [IndexToNoteTable[332 - note[1]]][0];
                const noteAndParent = createNote(noteId, noteDelay, synth)
                var noteToPlay = addOctaveValue(
                    noteAndParent[1].innerText // e.g. CÂ° to C5
                )

                console.log(noteToPlay + "scheduled at " + now + 2.5 + noteDelay * 0.001);

                Tone.Transport.scheduleOnce(time => {
                    synth.triggerAttackRelease(
                        noteToPlay,
                        0.5,
                        time,
                    )
                }, now + 2.5 + noteDelay * 0.001)
                //now + 2.5 + 0.5 + noteDelay * 0.001);
                // synth.triggerRelease(noteToPlay, now + 2.5 + 0.5 + noteDelay * 0.001);
                // synth._voices.splice(synth._voices.indexOf(noteToPlay), 1);
                // Tone.Draw.schedule(() => {
                //     noteAndParent[1].appendChild(noteAndParent[0]);
                // }, time + noteDelay * 0.001
                // );
            });

            Tone.Transport.start("+0.5");
        })
        .catch(error => {
            console.error('Error reading JSON file:', error);
        });

    function startTone() {
      // Start Tone.js
      Tone.start();

      // Create a div to display notes
      const noteDisplay = document.getElementById("noteDisplay");
      const synth = new Tone.PolySynth(Tone.Synth).toDestination();
      // Schedule an event at 1 minute (1m) into the audio transport timeline
      Tone.Transport.schedule(function(time){
        // This function will be called at the specified time
        console.log("Event scheduled at time:", time);

        
        synth.debug = true;
        // const now = Tone.now();
        const notes = ["D4", "F4", "A4", "C5", "E5"];

        // Trigger each note
        notes.forEach((note, index) => {
          synth.triggerAttackRelease(note, 1, time + index * 0.5);

          // Create a div element for each note and append it to the noteDisplay div
          const noteDiv = document.createElement("div");
          noteDiv.textContent = note;
          noteDisplay.appendChild(noteDiv);

          // Schedule the removal of the div after a short delay (e.g., 500 milliseconds)
          Tone.Draw.schedule(() => {
            noteDiv.remove();
          }, time + index * 0.5 + 0.5 * 2); // Remove after 2 beats (adjust as needed)
        });

        // Trigger the release of all notes after a certain duration
        //synth.triggerRelease(notes, now + 4);

        setInterval(
          () => {
            el = document.getElementById("the-note");
            const n = synth._voices.length;
            el.innerText = n;
          }, 250
        )
      }, 0);

      // Start the transport to begin scheduling and playing
      Tone.Transport.start();
    }

    // Attach the startTone function to the button click event
    document.getElementById("startButton").addEventListener("click", startTone);

  </script>
  <div id="the-note">Note</div>
</body>
</html>
